name: Build and Release Flutter App

on:
  push:
    tags:
      - 'v*' 
permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64, universal]

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      # åˆ‡æ¢ EXCLUDED_ARCHS
      - name: Switch EXCLUDED_ARCHS
        run: |
          PBXPROJ="macos/Runner.xcodeproj/project.pbxproj"
          ARCH=${{ matrix.arch }}
          if [[ "$ARCH" == "universal" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "";/g' "$PBXPROJ"
          elif [[ "$ARCH" == "x86_64" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "arm64";/g' "$PBXPROJ"
          elif [[ "$ARCH" == "arm64" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "x86_64";/g' "$PBXPROJ"
          fi

      # å®‰è£…æ‰“åŒ…å·¥å…·
      - run: dart pub global activate fastforge
      - run: npm install -g appdmg

      # æ‰“åŒ… DMG
      - run: fastforge package --platform macos --targets dmg

      # è·å– Flutter ç‰ˆæœ¬å·
      - name: Get Flutter version
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # é‡å‘½å DMG æ–‡ä»¶ï¼ŒåŠ å…¥æ¶æ„
      - name: Rename DMG with architecture
        run: |
          ARCH=${{ matrix.arch }}
          VERSION=${{ steps.get_version.outputs.version }}
          SRC="dist/$VERSION/lzf_music-$VERSION-macos.dmg"
          DST="dist/$VERSION/LZF-Music-$VERSION-macos-$ARCH.dmg"
          mv "$SRC" "$DST"

      # ä¸Šä¼ åˆ° Release 
      - name: Upload DMG to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ‰ å‘å¸ƒç‰ˆæœ¬ ${{ github.ref_name }}
            - æ”¯æŒ macOS å¤šæ¶æ„ DMG
          files: dist/${{ steps.get_version.outputs.version }}/LZF-Music-${{ steps.get_version.outputs.version }}-macos-${{ matrix.arch }}.dmg
